<html>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <link rel="stylesheet" href="index.css" />
</head>

<body>
    <div class="content">
        <section class="menu">
            <select id="predefined">
            </select>
            <textarea id="system"></textarea>
            <label>
                <span>Angle</span>
                <input id="angle" value="90" />
            </label>
            <label>
                <span>Length</span>
                <input id="length" value="20" />
            </label>
            <label>
                <span>Depth</span>
                <input id="depth" value="6" />
            </label>
            <button id="drawBtn">Rysuj</button>
            <button id="clearBtn">Czyść</button>
        </section>
        <main id="canvas-wrapper">
            <canvas id="canvas"></canvas>
        </main>
    </div>
    <script type="module">
        const predefined = [
            {
                key: "Hex",
                value: "F: F+F\nF",
                angle: 60,
                depth: 6,
                length: 40,
            },
            {
                key: "Koch flake",
                value: "F: F+F--F+F\nF--F--F",
                angle: 60,
                depth: 5,
                length: 4,
            },
            {
                key: "Square",
                value: "F:\nF+F+F+F",
                angle: 90,
                depth: 1,
                length: 200,
            },

            {
                key: "Plant",
                value: "F: FF+[+F-F-F]-[-F+F+F]\nF",
                angle: 22.5,
                depth: 5,
                length: 9,
            }
        ]

        import init, { create_points } from './pkg/l_systems_rs.js';

        var wrapper = document.getElementById("canvas-wrapper")
        const canvas = document.getElementById("canvas")
        const ctx = canvas.getContext("2d")
        const systemInput = document.getElementById("system")
        const angleInput = document.getElementById("angle")
        const lengthInput = document.getElementById("length")
        const depthInput = document.getElementById("depth")
        const predefinedSelect = document.getElementById("predefined")

        for (let element of predefined) {
            let newOption = document.createElement("option");
            newOption.value = element.key;
            newOption.text = element.key;
            newOption.key = element.key;
            predefinedSelect.appendChild(newOption)
        }

        assign_parameters(predefined[0])

        predefinedSelect.addEventListener("change", e => {
            let matching = predefined.find(x => x.key == e.target.value);
            assign_parameters(matching)
            clear_and_draw()
        })

        ctx.canvas.width = wrapper.clientWidth;
        ctx.canvas.height = wrapper.clientHeight;

        function assign_parameters(selected) {
            systemInput.value = selected.value;
            angleInput.value = selected.angle;
            lengthInput.value = selected.length
            depthInput.value = selected.depth
        }

        function draw_points(points) {
            ctx.beginPath()
            for (let i = 0; i < points.length; i++) {
                const start = points[i][0];
                const end = points[i][1];
                ctx.moveTo(start.x, start.y)
                ctx.lineTo(end.x, end.y)
            }
            ctx.stroke()
        }

        function clear_and_draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let angle = angleInput.value.trim();
            let depth = depthInput.value.trim();
            let length = lengthInput.value.trim();
            let system = systemInput.value.trim();
            let center_point = { x: canvas.width / 2, y: canvas.height / 2, z: 0 };

            let arg = {
                line_length: +length,
                recursion: +depth,
                angle: +angle,
                system,
                center_point,
            }

            let output = create_points(JSON.stringify(arg));

            draw_points(output)
        }

        async function run() {
            await init();
            clear_and_draw()
        }

        run();
    </script>
</body>

</html>